#!/usr/sbin/nft -f

flush ruleset

table inet pharaoh {
  sets {
    allowed_gaming_tcp = { type ipv4_addr; flags interval; auto-merge; }
    allowed_gaming_udp = { type ipv4_addr; flags interval; auto-merge; }
  }

  maps {
    preset_tcp = { type string : verdict; }
    preset_udp = { type string : verdict; }
  }

  chains {
    input {
      type filter hook input priority 0;
      policy drop;

      iifname "lo" accept
      ct state established,related accept
      tcp dport { 22 } accept comment "Allow SSH when explicitly enabled"
      ip protocol icmp accept
      counter drop
    }

    forward { type filter hook forward priority 0; policy drop; }

    output {
      type filter hook output priority 0;
      policy drop;

      oifname "lo" accept
      ct state established,related accept

      # DNS
      udp dport { 53 } accept
      tcp dport { 53 } accept

      # HTTPS and HTTP
      tcp dport { 80, 443 } accept

      # Steam typical ports
      udp dport { 27015-27050 } accept
      tcp dport { 27015-27050 } accept

      # Discord voice
      udp dport { 50000-65535 } accept

      # Allow preset-driven decisions
      meta mark set 0x1 counter accept
    }
  }
}

# Preset definitions are manipulated by pharaoh-firewall via nft command wrappers.
